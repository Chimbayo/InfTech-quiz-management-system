"use strict";(()=>{var e={};e.id=5407,e.ids=[5407],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},20330:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>w,patchFetch:()=>f,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h});var r={};i.r(r),i.d(r,{GET:()=>c});var n=i(49303),s=i(88716),o=i(60670),a=i(87070),u=i(13538),l=i(95456);async function c(e){try{let t,i,r;await (0,l.MH)("ADMIN");let{searchParams:n}=new URL(e.url),s=n.get("quizId"),o=parseInt(n.get("timeRange")||"30"),c=n.get("userId"),g=new Date;g.setDate(g.getDate()-o);let y={timestamp:{gte:g}};if(c&&(y.userId=c),s){let e=await u._.chatRoom.findMany({where:{quizId:s},select:{id:!0}});y.roomId={in:e.map(e=>e.id)}}let h=await u._.suspiciousActivity.findMany({where:y,include:{user:{select:{id:!0,name:!0,email:!0,role:!0}},room:{select:{id:!0,name:!0,type:!0,quiz:{select:{id:!0,title:!0}}}},message:{select:{id:!0,content:!0,createdAt:!0}}},orderBy:{timestamp:"desc"}}),v=await d(y),w=await p(y),f=s?await m(s):null,I=function(e,t){let i=[];e.filter(e=>"HIGH"===e.severity).length>5&&(i.push("Immediate review required: High number of severe violations detected"),i.push("Consider implementing stricter chat monitoring during quiz periods")),t.repeatOffenders.length>0&&(i.push(`Monitor ${t.repeatOffenders.length} repeat offenders closely`),i.push("Consider individual meetings with students showing repeated violations"));let r=Object.entries(t.hourlyDistribution).sort(([,e],[,t])=>t.total-e.total)[0];r&&r[1].total>5&&i.push(`Increase monitoring during ${r[0]}:00 - peak violation time`);let n=t.violationsByType.find(e=>"KEYWORD_MATCH"===e.type);n&&n.count>10&&(i.push("Review and update suspicious keyword detection rules"),i.push("Provide clearer guidelines on acceptable chat behavior during quizzes"));let s=t.violationsByType.find(e=>"TIMING_VIOLATION"===e.type);return s&&s.count>5&&(i.push("Enforce stricter chat restrictions during active quiz periods"),i.push("Consider disabling chat completely during quiz attempts")),e.length>20&&(i.push("Conduct academic integrity workshop for students"),i.push("Review quiz security measures and chat policies")),i}(h,v),q={totalViolations:h.length,highSeverityViolations:h.filter(e=>"HIGH"===e.severity).length,mediumSeverityViolations:h.filter(e=>"MEDIUM"===e.severity).length,lowSeverityViolations:h.filter(e=>"LOW"===e.severity).length,resolvedViolations:h.filter(e=>e.resolved).length,uniqueUsers:new Set(h.map(e=>e.userId)).size,uniqueQuizzes:new Set(h.map(e=>e.room.quiz?.id).filter(Boolean)).size,timeRange:o},x=((r=Math.max(0,Math.round(r=100-5*q.highSeverityViolations-2*q.mediumSeverityViolations-.5*q.lowSeverityViolations-3*v.repeatOffenders.length)))>=90?(t="EXCELLENT",i="Very high academic integrity with minimal violations"):r>=75?(t="GOOD",i="Good academic integrity with some minor concerns"):r>=60?(t="FAIR",i="Moderate integrity concerns requiring attention"):r>=40?(t="POOR",i="Significant integrity issues requiring immediate action"):(t="CRITICAL",i="Critical integrity violations requiring urgent intervention"),{score:r,level:t,description:i});return a.NextResponse.json({summary:q,integrityScore:x,suspiciousActivities:h.map(e=>({id:e.id,type:e.type,severity:e.severity,description:e.description,evidence:e.evidence?JSON.parse(e.evidence):null,timestamp:e.timestamp,resolved:e.resolved,user:e.user,room:e.room,message:e.message})),patternAnalysis:v,userRiskAssessment:w,quizAnalysis:f,recommendations:I})}catch(e){return console.error("Error generating integrity report:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e){let t=await u._.suspiciousActivity.groupBy({by:["type"],where:e,_count:{id:!0}}),i=(await u._.suspiciousActivity.findMany({where:e,select:{timestamp:!0,severity:!0}})).reduce((e,t)=>{let i=new Date(t.timestamp).getHours();return e[i]||(e[i]={total:0,high:0,medium:0,low:0}),e[i].total++,e[i][t.severity?.toLowerCase()]=(e[i][t.severity?.toLowerCase()]||0)+1,e},{}),r=await u._.suspiciousActivity.groupBy({by:["userId"],where:e,_count:{id:!0},having:{id:{_count:{gt:3}}}}),n=await u._.user.findMany({where:{id:{in:r.map(e=>e.userId)}},select:{id:!0,name:!0,email:!0,role:!0}});return{violationsByType:t.map(e=>({type:e.type,count:e._count.id})),hourlyDistribution:i,repeatOffenders:r.map(e=>({...e,user:n.find(t=>t.id===e.userId),violationCount:e._count.id}))}}async function p(e){let t=(await u._.suspiciousActivity.groupBy({by:["userId","severity"],where:e,_count:{id:!0}})).reduce((e,t)=>{e[t.userId]||(e[t.userId]={high:0,medium:0,low:0,total:0});let i=t.severity?.toLowerCase();return e[t.userId][i]+=t._count.id,e[t.userId].total+=t._count.id,e},{}),i=Object.keys(t);return(await u._.user.findMany({where:{id:{in:i}},select:{id:!0,name:!0,email:!0,role:!0}})).map(e=>{let i;let r=t[e.id],n=(3*r.high+2*r.medium+1*r.low)/r.total;return i=n>=2.5||r.high>=3?"HIGH":n>=1.5||r.medium>=5?"MEDIUM":"LOW",{user:e,violations:r,riskScore:Math.round(100*n)/100,riskLevel:i}}).sort((e,t)=>t.riskScore-e.riskScore)}async function m(e){let t=await u._.quiz.findUnique({where:{id:e},include:{chatRooms:{include:{suspiciousActivities:{include:{user:{select:{id:!0,name:!0,email:!0}}}}}},attempts:{include:{user:{select:{id:!0,name:!0,email:!0}}}}}});if(!t)return null;let i=t.chatRooms.flatMap(e=>e.suspiciousActivities),r=t.attempts.map(e=>e.user.id),n=i.map(e=>e.userId),s=r.filter(e=>n.includes(e));return{quizTitle:t.title,totalAttempts:t.attempts.length,totalViolations:i.length,compromisedAttempts:s.length,integrityScore:Math.max(0,100-s.length/t.attempts.length*100),violationsByType:i.reduce((e,t)=>(e[t.type]=(e[t.type]||0)+1,e),{})}}let g=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/reports/academic-integrity/route",pathname:"/api/reports/academic-integrity",filename:"route",bundlePath:"app/api/reports/academic-integrity/route"},resolvedPagePath:"C:\\Users\\HP\\Documents\\InfTech-quiz-management-system\\src\\app\\api\\reports\\academic-integrity\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:v}=g,w="/api/reports/academic-integrity/route";function f(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},95456:(e,t,i)=>{i.d(t,{Gg:()=>n,MH:()=>o});var r=i(71615);async function n(){try{let e=(0,r.cookies)().get("user-session");if(!e||!e.value||""===e.value.trim())return null;let t=JSON.parse(e.value);if(!t||!t.id||!t.email||!t.name||!t.role)return console.warn("Invalid session structure:",t),null;return t}catch(e){return console.error("Error getting session:",e),null}}async function s(){let e=await n();if(!e)throw Error("Authentication required");return e}async function o(e){let t=await s();if(t.role!==e)throw Error(`Access denied. Required role: ${e}`);return t}},13538:(e,t,i)=>{i.d(t,{_:()=>n});var r=i(53524);let n=globalThis.prisma??new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[9276,1615,5972],()=>i(20330));module.exports=r})();