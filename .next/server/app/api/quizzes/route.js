"use strict";(()=>{var e={};e.id=6645,e.ids=[6645],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},17946:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>S,requestAsyncStorage:()=>I,routeModule:()=>q,serverHooks:()=>z,staticGenerationAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{GET:()=>g,POST:()=>h,dynamic:()=>p});var i=r(49303),a=r(88716),o=r(60670),n=r(87070),u=r(13538),c=r(95456),d=r(91585),l=r(26033),m=r(3950);let p="force-dynamic",y=d.Ry({title:d.Z_().min(1),description:d.Z_().optional(),passingScore:d.Rx().min(0).max(100),timeLimit:d.Rx().min(1).optional(),isActive:d.O7().optional(),startAt:d.Z_().datetime().optional(),creatorId:d.Z_(),enableChat:d.O7().optional(),chatRoomName:d.Z_().optional(),allowChatDuringQuiz:d.O7().optional(),enableStudyGroup:d.O7().optional(),questions:d.IX(d.Ry({text:d.Z_().min(1),type:d.Km(["MULTIPLE_CHOICE","TRUE_FALSE"]),options:d.IX(d.Ry({text:d.Z_().min(1),isCorrect:d.O7()})).min(2)}).refine(e=>1===e.options.filter(e=>e.isCorrect).length,{message:"Exactly one option must be marked as correct"})).min(1)});async function h(e){try{let t=await (0,c.MH)("ADMIN"),r=await e.json(),s=y.parse(r);if(s.creatorId!==t.id)return n.NextResponse.json({error:"Unauthorized"},{status:403});let i=await u._.quiz.create({data:{title:s.title,description:s.description,passingScore:s.passingScore,timeLimit:s.timeLimit,isActive:s.isActive??!1,enableChat:s.enableChat??!1,startAt:s.startAt?new Date(s.startAt):null,creatorId:s.creatorId,questions:{create:s.questions.map((e,t)=>({text:e.text,type:e.type,order:t+1,options:{create:e.options.map((e,t)=>({text:e.text,isCorrect:e.isCorrect,order:t+1}))}}))}},include:{questions:{include:{options:!0}}}});if(s.enableChat)try{let e=s.chatRoomName||`${i.title} - Discussion`,t=await u._.chatRoom.create({data:{name:e,type:"QUIZ_DISCUSSION",quizId:i.id,createdBy:s.creatorId,allowChatDuringQuiz:s.allowChatDuringQuiz||!1,isActive:!0}});if(await u._.chatMessage.create({data:{roomId:t.id,userId:s.creatorId,content:`ðŸ“š Discussion room created for quiz: ${i.title}. Students can join after completing the quiz.`,isSystemMessage:!0}}),s.enableStudyGroup){let e=await u._.studyGroup.create({data:{name:`${i.title} - Study Group`,description:`Collaborative study group for ${i.title}`,quizId:i.id,createdBy:s.creatorId}}),t=await u._.chatRoom.create({data:{name:`${i.title} - Study Group`,type:"STUDY_GROUP",studyGroupId:e.id,createdBy:s.creatorId,allowChatDuringQuiz:!0,isActive:!0}});await u._.chatMessage.create({data:{roomId:t.id,userId:s.creatorId,content:`ðŸ‘¥ Study group created! Collaborate and help each other learn about: ${i.title}`,isSystemMessage:!0}})}console.log(`Auto-created chat room for quiz: ${i.title}`)}catch(e){console.warn("Failed to create chat room for quiz:",e)}if(i.isActive)try{await fetch(`${process.env.NEXTAUTH_URL||"http://localhost:3001"}/api/socketio`,{method:"POST"});let e=global.io;if(e){let t=(0,m.I)(e);await t.broadcastQuizStatus({quizId:i.id,type:"PUBLISHED",message:`New quiz "${i.title}" has been published and is now available!`,sentBy:s.creatorId}),e.emit("new-quiz-notification",{id:`quiz-${i.id}`,message:`ðŸ“š New quiz available: "${i.title}"`,quizId:i.id,quizTitle:i.title,createdAt:i.createdAt}),console.log("Quiz creation notification sent:",i.title)}else console.warn("WebSocket IO not available for broadcasting")}catch(e){console.warn("Failed to broadcast quiz creation:",e)}return n.NextResponse.json(i)}catch(e){if(console.error("Create quiz error:",e),e instanceof l.jm)return n.NextResponse.json({error:"Invalid data",details:e.errors},{status:400});return n.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e){try{let t;let{searchParams:r}=new URL(e.url),s=r.get("role");if("student"===s)t=await u._.quiz.findMany({where:{isActive:!0},include:{creator:{select:{name:!0}},chatRooms:{where:{isActive:!0},select:{id:!0,name:!0,type:!0}},_count:{select:{questions:!0,attempts:!0}}},orderBy:{createdAt:"desc"}});else{let e=await (0,c.MH)("ADMIN");t=await u._.quiz.findMany({where:{creatorId:e.id},include:{_count:{select:{questions:!0,attempts:!0}}},orderBy:{createdAt:"desc"}})}return n.NextResponse.json(t)}catch(e){return console.error("Get quizzes error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let q=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/quizzes/route",pathname:"/api/quizzes",filename:"route",bundlePath:"app/api/quizzes/route"},resolvedPagePath:"C:\\Users\\HP\\Documents\\InfTech-quiz-management-system\\src\\app\\api\\quizzes\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:I,staticGenerationAsyncStorage:w,serverHooks:z}=q,f="/api/quizzes/route";function S(){return(0,o.patchFetch)({serverHooks:z,staticGenerationAsyncStorage:w})}},95456:(e,t,r)=>{r.d(t,{Gg:()=>i,MH:()=>o});var s=r(71615);async function i(){try{let e=(0,s.cookies)().get("user-session");if(!e||!e.value||""===e.value.trim())return null;let t=JSON.parse(e.value);if(!t||!t.id||!t.email||!t.name||!t.role)return console.warn("Invalid session structure:",t),null;return t}catch(e){return console.error("Error getting session:",e),null}}async function a(){let e=await i();if(!e)throw Error("Authentication required");return e}async function o(e){let t=await a();if(t.role!==e)throw Error(`Access denied. Required role: ${e}`);return t}},13538:(e,t,r)=>{r.d(t,{_:()=>i});var s=r(53524);let i=globalThis.prisma??new s.PrismaClient},3950:(e,t,r)=>{r.d(t,{I:()=>o});var s=r(13538);class i{constructor(e){this.io=e}async broadcastQuizStatus(e){try{let t=await s._.quizBroadcast.create({data:{quizId:e.quizId,type:e.type,message:e.message,sentBy:e.sentBy},include:{quiz:{select:{title:!0,chatRooms:{select:{id:!0}},studyGroups:{select:{id:!0,chatRooms:{select:{id:!0}}}}}},sender:{select:{name:!0,role:!0}}}});for(let r of[...t.quiz.chatRooms.map(e=>e.id),...t.quiz.studyGroups.flatMap(e=>e.chatRooms.map(e=>e.id))])this.io.to(r).emit("quiz-status-update",{id:t.id,quizId:e.quizId,quizTitle:t.quiz.title,type:e.type,message:e.message,sender:t.sender,timestamp:t.timestamp});return this.io.emit("quiz-announcement",{id:t.id,quizId:e.quizId,quizTitle:t.quiz.title,type:e.type,message:e.message,sender:t.sender,timestamp:t.timestamp}),t}catch(e){throw console.error("Error broadcasting quiz status:",e),e}}async broadcastStudyProgress(e){try{let t=await s._.studyGroup.findUnique({where:{id:e.studyGroupId},include:{chatRooms:{select:{id:!0}},members:{include:{user:{select:{id:!0,name:!0}}}}}});if(!t)throw Error("Study group not found");let r=await s._.user.findUnique({where:{id:e.userId},select:{name:!0,role:!0}});for(let s of t.chatRooms)this.io.to(s.id).emit("study-progress-update",{studyGroupId:e.studyGroupId,studyGroupName:t.name,userId:e.userId,userName:r?.name,progressType:e.progressType,message:e.message,data:e.data,timestamp:new Date().toISOString()});for(let i of t.chatRooms)await s._.chatMessage.create({data:{roomId:i.id,userId:e.userId,content:e.message,isSystemMessage:!0}}),this.io.to(i.id).emit("new-message",{id:Date.now().toString(),content:e.message,user:{id:e.userId,name:r?.name||"System",role:r?.role||"SYSTEM"},createdAt:new Date().toISOString(),isSystemMessage:!0})}catch(e){throw console.error("Error broadcasting study progress:",e),e}}async broadcastInstructorPresence(e,t,r){try{let i=await s._.user.findUnique({where:{id:e},select:{name:!0,role:!0}});if(!i||"TEACHER"!==i.role&&"ADMIN"!==i.role)return;let a={userId:e,userName:i.name,userRole:i.role,isOnline:t,timestamp:new Date().toISOString()};r?this.io.to(r).emit("instructor-presence-update",{...a,roomId:r}):this.io.emit("instructor-presence-update",a)}catch(e){console.error("Error broadcasting instructor presence:",e)}}async broadcastStudySessionUpdate(e,t){try{let r=await s._.studySession.findUnique({where:{id:e},include:{creator:{select:{name:!0}},studyGroup:{select:{name:!0}},quiz:{select:{title:!0}}}});if(!r)throw Error("Study session not found");let i={sessionId:e,sessionName:r.name,studyGroupName:r.studyGroup?.name,quizTitle:r.quiz?.title,type:t.type,message:t.message,data:t.data,timestamp:new Date().toISOString()};if(this.io.to(`study-session-${e}`).emit("study-session-update",i),r.studyGroupId){let e=await s._.studyGroup.findUnique({where:{id:r.studyGroupId},include:{chatRooms:{select:{id:!0}}}});if(e)for(let t of e.chatRooms)this.io.to(t.id).emit("study-session-update",i)}}catch(e){console.error("Error broadcasting study session update:",e)}}}let a=null,o=e=>{if(!a&&e&&(a=new i(e)),!a)throw Error("Broadcast instance not initialized");return a}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,1615,5972,1585],()=>r(17946));module.exports=s})();