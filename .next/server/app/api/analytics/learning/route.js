"use strict";(()=>{var e={};e.id=2010,e.ids=[2010],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},22541:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>l});var n=r(49303),a=r(88716),o=r(60670),u=r(87070),i=r(13538),c=r(95456);async function l(e){try{await (0,c.MH)("ADMIN");let{searchParams:t}=new URL(e.url),r=t.get("timeRange")||"30",s=t.get("quizId"),n=new Date;n.setDate(n.getDate()-parseInt(r));let a={createdAt:{gte:n}};s&&(a.roomId={in:await i._.chatRoom.findMany({where:{quizId:s},select:{id:!0}}).then(e=>e.map(e=>e.id))});let o=await i._.chatMessage.groupBy({by:["userId"],where:a,_count:{id:!0}}),l=o.map(e=>e.userId),d=await i._.quizAttempt.groupBy({by:["userId"],where:{userId:{in:l},completedAt:{gte:n},...s&&{quizId:s}},_avg:{score:!0},_count:{id:!0}}),m=o.map(e=>{let t=d.find(t=>t.userId===e.userId);return{userId:e.userId,messageCount:e._count.id,averageScore:t?._avg.score||0,quizAttempts:t?._count.id||0}}),g=(await i._.chatMessage.findMany({where:{...a,room:{type:{in:["QUIZ_DISCUSSION","STUDY_GROUP"]}}},select:{userId:!0,createdAt:!0,room:{select:{type:!0,quizId:!0}}},orderBy:{createdAt:"asc"}})).reduce((e,t)=>{e[t.userId]||(e[t.userId]={totalMessages:0,quizDiscussionMessages:0,studyGroupMessages:0,studySessions:[],peakHours:{}}),e[t.userId].totalMessages++,"QUIZ_DISCUSSION"===t.room.type?e[t.userId].quizDiscussionMessages++:"STUDY_GROUP"===t.room.type&&e[t.userId].studyGroupMessages++;let r=new Date(t.createdAt).getHours();return e[t.userId].peakHours[r]=(e[t.userId].peakHours[r]||0)+1,e},{}),p=(await i._.chatMessage.findMany({where:{...a,content:{contains:"?"}},include:{user:{select:{id:!0,name:!0,role:!0}},room:{select:{type:!0,name:!0}}}})).reduce((e,t)=>{let r=t.content.includes("?"),s=t.userId;return e[s]||(e[s]={questionsAsked:0,helpProvided:0,userName:t.user.name,userRole:t.user.role}),r&&e[s].questionsAsked++,e},{}),h=await i._.chatMessage.findMany({where:{...a,user:{role:{in:["ADMIN","TEACHER"]}}},include:{user:{select:{id:!0,name:!0,role:!0}},room:{select:{type:!0,name:!0,quiz:{select:{id:!0,title:!0}}}}}}),y=(await i._.studyGroup.findMany({where:{createdAt:{gte:n}},include:{members:{include:{user:{include:{attempts:{where:{completedAt:{gte:n}},select:{score:!0,passed:!0,quiz:{select:{id:!0,title:!0}}}}}}}},chatRooms:{include:{_count:{select:{messages:!0}}}}}})).map(e=>{let t=e.members.flatMap(e=>e.user.attempts.map(e=>e.score)),r=t.length>0?t.reduce((e,t)=>e+t,0)/t.length:0,s=e.members.length>0?e.members.filter(e=>e.user.attempts.some(e=>e.passed)).length/e.members.length:0,n=e.chatRooms.reduce((e,t)=>e+t._count?.messages||0,0);return{groupId:e.id,groupName:e.name,memberCount:e.members.length,averageScore:r,passRate:s,totalMessages:n,messagesPerMember:e.members.length>0?n/e.members.length:0}}),I=(await i._.chatMessage.groupBy({by:["createdAt"],where:a,_count:{id:!0}})).reduce((e,t)=>{let r=new Date(t.createdAt).toISOString().split("T")[0];return e[r]=(e[r]||0)+t._count.id,e},{});return u.NextResponse.json({engagementCorrelation:m,userStudyPatterns:g,peerInteractions:p,teacherInterventions:{total:h.length,byTeacher:h.reduce((e,t)=>{let r=t.user.id;return e[r]||(e[r]={name:t.user.name,interventions:0,rooms:new Set}),e[r].interventions++,e[r].rooms.add(t.room.name),e},{})},studyGroupEffectiveness:y,dailyActivity:I,summary:{totalUsers:Object.keys(g).length,totalMessages:Object.values(g).reduce((e,t)=>e+t.totalMessages,0),averageEngagement:m.length>0?m.reduce((e,t)=>e+t.messageCount,0)/m.length:0,correlationStrength:function(e){if(e.length<2)return 0;let t=e.length,r=e.reduce((e,t)=>e+t.messageCount,0),s=e.reduce((e,t)=>e+t.averageScore,0),n=e.reduce((e,t)=>e+t.messageCount*t.averageScore,0),a=e.reduce((e,t)=>e+t.messageCount*t.messageCount,0),o=e.reduce((e,t)=>e+t.averageScore*t.averageScore,0),u=Math.sqrt((t*a-r*r)*(t*o-s*s));return 0===u?0:(t*n-r*s)/u}(m)}})}catch(e){return console.error("Error fetching learning analytics:",e),u.NextResponse.json({error:"Internal server error"},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/analytics/learning/route",pathname:"/api/analytics/learning",filename:"route",bundlePath:"app/api/analytics/learning/route"},resolvedPagePath:"C:\\Users\\HP\\Documents\\InfTech-quiz-management-system\\src\\app\\api\\analytics\\learning\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:p}=d,h="/api/analytics/learning/route";function y(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:g})}},95456:(e,t,r)=>{r.d(t,{Gg:()=>n,MH:()=>o});var s=r(71615);async function n(){try{let e=(0,s.cookies)().get("user-session");if(!e||!e.value||""===e.value.trim())return null;let t=JSON.parse(e.value);if(!t||!t.id||!t.email||!t.name||!t.role)return console.warn("Invalid session structure:",t),null;return t}catch(e){return console.error("Error getting session:",e),null}}async function a(){let e=await n();if(!e)throw Error("Authentication required");return e}async function o(e){let t=await a();if(t.role!==e)throw Error(`Access denied. Required role: ${e}`);return t}},13538:(e,t,r)=>{r.d(t,{_:()=>n});var s=r(53524);let n=globalThis.prisma??new s.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,1615,5972],()=>r(22541));module.exports=s})();