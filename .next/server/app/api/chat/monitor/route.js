"use strict";(()=>{var e={};e.id=547,e.ids=[547],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},97234:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var r={};i.r(r),i.d(r,{GET:()=>m,POST:()=>p,dynamic:()=>d});var s=i(49303),n=i(88716),o=i(60670),a=i(87070),c=i(13538),u=i(95456),l=i(83961);let d="force-dynamic";async function p(e){try{let t=await (0,u.Gg)();if(!t||!["ADMIN","TEACHER"].includes(t.role))return a.NextResponse.json({error:"Unauthorized"},{status:401});let{roomId:i,messageId:r,content:s,userId:n}=await e.json();if(!i||!s||!n)return a.NextResponse.json({error:"Missing required fields"},{status:400});let o=[],d=(0,l.Af)(s);d.isSuspicious&&o.push({type:"KEYWORD_MATCH",severity:d.severity,description:`Suspicious keywords detected: ${d.matchedKeywords.join(", ")}`,evidence:d.matchedKeywords,timestamp:new Date,userId:n,roomId:i,messageId:r});let p=await c._.chatRoom.findUnique({where:{id:i},include:{quiz:!0}});if(p?.quiz){let e=await c._.quizAttempt.findMany({where:{quizId:p.quiz.id,completedAt:null,userId:n}});e.length>0&&!p.allowChatDuringQuiz&&o.push({type:"TIMING_VIOLATION",severity:"HIGH",description:"Chat message sent during active quiz attempt",evidence:[`Active quiz attempt: ${e[0].id}`],timestamp:new Date,userId:n,roomId:i,messageId:r})}for(let e of o)try{await c._.suspiciousActivity.create({data:{type:e.type,severity:e.severity,description:e.description,evidence:JSON.stringify(e.evidence),userId:e.userId,roomId:e.roomId,messageId:e.messageId,timestamp:e.timestamp}})}catch(e){console.error("Failed to log suspicious activity:",e)}let m=(0,l.zt)(o);return a.NextResponse.json({flagged:o.length>0,activities:o,report:m,keywordAnalysis:d})}catch(e){return console.error("Error monitoring chat:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=await (0,u.Gg)();if(!t||!["ADMIN","TEACHER"].includes(t.role))return a.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:i}=new URL(e.url),r=i.get("roomId"),s=i.get("severity"),n=parseInt(i.get("limit")||"50"),o={};r&&(o.roomId=r),s&&(o.severity=s);let l=await c._.suspiciousActivity.findMany({where:o,include:{user:{select:{id:!0,name:!0,email:!0}},room:{select:{id:!0,name:!0,type:!0}},message:{select:{id:!0,content:!0,createdAt:!0}}},orderBy:{timestamp:"desc"},take:n});return a.NextResponse.json({activities:l})}catch(e){return console.error("Error fetching suspicious activities:",e),a.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/chat/monitor/route",pathname:"/api/chat/monitor",filename:"route",bundlePath:"app/api/chat/monitor/route"},resolvedPagePath:"C:\\Users\\HP\\Documents\\InfTech-quiz-management-system\\src\\app\\api\\chat\\monitor\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:f}=h,v="/api/chat/monitor/route";function w(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},83961:(e,t,i)=>{i.d(t,{Af:()=>s,j0:()=>o,zt:()=>n});let r=["answer","answers","solution","solutions","cheat","cheating","copy","copying","share","sharing","help me","give me","question","questions","what is","which one","correct answer","right answer","wrong answer","option a","option b","option c","option d","choice a","choice b","choice c","choice d","plagiarize","plagiarism","steal","stolen","fake","fabricate","lie","lying","dishonest","fraud","fraudulent","together","collaborate","work together","team up","group work","split up","divide","you do","i do","take turns","google","search","look up","find online","internet","website","chatgpt","ai","artificial intelligence","bot","automated","more time","extra time","extend","extension","pause","stop timer","reset","restart","technical issue","computer problem"];function s(e){let t=e.toLowerCase(),i=[];for(let e of r)t.includes(e.toLowerCase())&&i.push(e);let s="LOW";if(i.length>=3)s="HIGH";else if(i.length>=2)s="MEDIUM";else if(i.length>=1){let e=["cheat","answer","solution","copy","share"];s=i.some(t=>e.some(e=>t.toLowerCase().includes(e)))?"HIGH":"LOW"}return{isSuspicious:i.length>0,matchedKeywords:i,severity:s}}function n(e){let t=e.filter(e=>"HIGH"===e.severity).length,i=e.filter(e=>"MEDIUM"===e.severity).length,r=e.filter(e=>"LOW"===e.severity).length,s="LOW",n="No significant integrity concerns detected.",o=[];return t>0?(s="HIGH",n=`${t} high-risk activities detected. Immediate review recommended.`,o.push("Review flagged messages immediately"),o.push("Consider invalidating quiz attempts if cheating is confirmed"),o.push("Contact affected students for clarification")):i>2?(s="HIGH",n=`${i} medium-risk activities detected. Pattern suggests potential issues.`,o.push("Review message patterns for academic dishonesty"),o.push("Monitor students more closely in future assessments")):(i>0||r>3)&&(s="MEDIUM",n=`${i+r} suspicious activities detected. Monitoring recommended.`,o.push("Keep records of flagged activities"),o.push("Consider additional proctoring measures")),e.some(e=>"TIMING_VIOLATION"===e.type)&&o.push("Ensure chat restrictions during quizzes are properly enforced"),e.some(e=>"KEYWORD_MATCH"===e.type)&&o.push("Review chat content for academic integrity violations"),{riskLevel:s,summary:n,recommendations:o}}async function o(e,t,i){let r=[],n=s(e);return n.isSuspicious&&r.push({type:"KEYWORD_MATCH",severity:n.severity,description:`Suspicious keywords detected: ${n.matchedKeywords.join(", ")}`,evidence:n.matchedKeywords,timestamp:new Date,userId:t,roomId:i}),{isFlagged:r.length>0,severity:r.length>0?r[0].severity:"LOW",activities:r}}},95456:(e,t,i)=>{i.d(t,{Gg:()=>s,MH:()=>o});var r=i(71615);async function s(){try{let e=(0,r.cookies)().get("user-session");if(!e||!e.value||""===e.value.trim())return null;let t=JSON.parse(e.value);if(!t||!t.id||!t.email||!t.name||!t.role)return console.warn("Invalid session structure:",t),null;return t}catch(e){return console.error("Error getting session:",e),null}}async function n(){let e=await s();if(!e)throw Error("Authentication required");return e}async function o(e){let t=await n();if(t.role!==e)throw Error(`Access denied. Required role: ${e}`);return t}},13538:(e,t,i)=>{i.d(t,{_:()=>s});var r=i(53524);let s=globalThis.prisma??new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[9276,1615,5972],()=>i(97234));module.exports=r})();