"use strict";(()=>{var e={};e.id=5864,e.ids=[5864],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},68970:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>z,patchFetch:()=>S,requestAsyncStorage:()=>f,routeModule:()=>q,serverHooks:()=>I,staticGenerationAsyncStorage:()=>w});var r={};s.r(r),s.d(r,{GET:()=>h,POST:()=>g,dynamic:()=>p});var n=s(49303),a=s(88716),o=s(60670),i=s(87070),u=s(13538),d=s(95456),c=s(91585),l=s(26033),m=s(3950);let p="force-dynamic",y=c.Ry({message:c.Z_().min(1,"Message is required"),type:c.Z_().default("GENERAL"),quizId:c.Z_().optional()});async function g(e){try{let t=await (0,d.MH)("ADMIN"),s=await e.json(),r=y.parse(s),n=await u._.announcement.create({data:{message:r.message,type:r.type,quizId:r.quizId,sentBy:t.id},include:{sender:{select:{name:!0,role:!0}},quiz:r.quizId?{select:{title:!0}}:void 0}});try{let e=global.io;if(e){(0,m.I)(e);let s=r.quizId?`ðŸ“¢ New announcement about "${n.quiz?.title}": ${r.message}`:`ðŸ“¢ General announcement: ${r.message}`;e.emit("new-announcement",{id:n.id,message:s,type:r.type,quizId:r.quizId,sentBy:t.name,sentAt:n.createdAt})}}catch(e){console.warn("Failed to broadcast announcement:",e)}return i.NextResponse.json(n)}catch(e){if(console.error("Create announcement error:",e),e instanceof l.jm)return i.NextResponse.json({error:"Invalid data",details:e.errors},{status:400});return i.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let{searchParams:t}=new URL(e.url),s=parseInt(t.get("limit")||"10"),r=await u._.announcement.findMany({include:{sender:{select:{name:!0,role:!0}},quiz:{select:{title:!0}}},orderBy:{createdAt:"desc"},take:s});return i.NextResponse.json(r)}catch(e){return console.error("Get announcements error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let q=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/announcements/route",pathname:"/api/announcements",filename:"route",bundlePath:"app/api/announcements/route"},resolvedPagePath:"C:\\Users\\HP\\Documents\\InfTech-quiz-management-system\\src\\app\\api\\announcements\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:w,serverHooks:I}=q,z="/api/announcements/route";function S(){return(0,o.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:w})}},95456:(e,t,s)=>{s.d(t,{Gg:()=>n,MH:()=>o});var r=s(71615);async function n(){try{let e=(0,r.cookies)().get("user-session");if(!e||!e.value||""===e.value.trim())return null;let t=JSON.parse(e.value);if(!t||!t.id||!t.email||!t.name||!t.role)return console.warn("Invalid session structure:",t),null;return t}catch(e){return console.error("Error getting session:",e),null}}async function a(){let e=await n();if(!e)throw Error("Authentication required");return e}async function o(e){let t=await a();if(t.role!==e)throw Error(`Access denied. Required role: ${e}`);return t}},13538:(e,t,s)=>{s.d(t,{_:()=>n});var r=s(53524);let n=globalThis.prisma??new r.PrismaClient},3950:(e,t,s)=>{s.d(t,{I:()=>o});var r=s(13538);class n{constructor(e){this.io=e}async broadcastQuizStatus(e){try{let t=await r._.quizBroadcast.create({data:{quizId:e.quizId,type:e.type,message:e.message,sentBy:e.sentBy},include:{quiz:{select:{title:!0,chatRooms:{select:{id:!0}},studyGroups:{select:{id:!0,chatRooms:{select:{id:!0}}}}}},sender:{select:{name:!0,role:!0}}}});for(let s of[...t.quiz.chatRooms.map(e=>e.id),...t.quiz.studyGroups.flatMap(e=>e.chatRooms.map(e=>e.id))])this.io.to(s).emit("quiz-status-update",{id:t.id,quizId:e.quizId,quizTitle:t.quiz.title,type:e.type,message:e.message,sender:t.sender,timestamp:t.timestamp});return this.io.emit("quiz-announcement",{id:t.id,quizId:e.quizId,quizTitle:t.quiz.title,type:e.type,message:e.message,sender:t.sender,timestamp:t.timestamp}),t}catch(e){throw console.error("Error broadcasting quiz status:",e),e}}async broadcastStudyProgress(e){try{let t=await r._.studyGroup.findUnique({where:{id:e.studyGroupId},include:{chatRooms:{select:{id:!0}},members:{include:{user:{select:{id:!0,name:!0}}}}}});if(!t)throw Error("Study group not found");let s=await r._.user.findUnique({where:{id:e.userId},select:{name:!0,role:!0}});for(let r of t.chatRooms)this.io.to(r.id).emit("study-progress-update",{studyGroupId:e.studyGroupId,studyGroupName:t.name,userId:e.userId,userName:s?.name,progressType:e.progressType,message:e.message,data:e.data,timestamp:new Date().toISOString()});for(let n of t.chatRooms)await r._.chatMessage.create({data:{roomId:n.id,userId:e.userId,content:e.message,isSystemMessage:!0}}),this.io.to(n.id).emit("new-message",{id:Date.now().toString(),content:e.message,user:{id:e.userId,name:s?.name||"System",role:s?.role||"SYSTEM"},createdAt:new Date().toISOString(),isSystemMessage:!0})}catch(e){throw console.error("Error broadcasting study progress:",e),e}}async broadcastInstructorPresence(e,t,s){try{let n=await r._.user.findUnique({where:{id:e},select:{name:!0,role:!0}});if(!n||"TEACHER"!==n.role&&"ADMIN"!==n.role)return;let a={userId:e,userName:n.name,userRole:n.role,isOnline:t,timestamp:new Date().toISOString()};s?this.io.to(s).emit("instructor-presence-update",{...a,roomId:s}):this.io.emit("instructor-presence-update",a)}catch(e){console.error("Error broadcasting instructor presence:",e)}}async broadcastStudySessionUpdate(e,t){try{let s=await r._.studySession.findUnique({where:{id:e},include:{creator:{select:{name:!0}},studyGroup:{select:{name:!0}},quiz:{select:{title:!0}}}});if(!s)throw Error("Study session not found");let n={sessionId:e,sessionName:s.name,studyGroupName:s.studyGroup?.name,quizTitle:s.quiz?.title,type:t.type,message:t.message,data:t.data,timestamp:new Date().toISOString()};if(this.io.to(`study-session-${e}`).emit("study-session-update",n),s.studyGroupId){let e=await r._.studyGroup.findUnique({where:{id:s.studyGroupId},include:{chatRooms:{select:{id:!0}}}});if(e)for(let t of e.chatRooms)this.io.to(t.id).emit("study-session-update",n)}}catch(e){console.error("Error broadcasting study session update:",e)}}}let a=null,o=e=>{if(!a&&e&&(a=new n(e)),!a)throw Error("Broadcast instance not initialized");return a}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9276,1615,5972,1585],()=>s(68970));module.exports=r})();